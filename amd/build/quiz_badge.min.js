define("local_agentdetect/quiz_badge",["exports","core/ajax","core/log"],(function(_exports,_ajax,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Quiz badge injection module.
   *
   * Adds visual agent detection indicators next to student names on
   * quiz report overview and quiz review pages.
   *
   * @module     local_agentdetect/quiz_badge
   * @copyright  2026 Cursive Technology <joe@cursivetechnology.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log);_exports.init=config=>{_log.default.debug("[AgentDetect Badge] Initialising with config:",config),"overview"===config.mode?injectOverviewBadges(config):"review"===config.mode&&injectReviewBadge(config)};const injectOverviewBadges=async config=>{const userLinks=document.querySelectorAll('table.quizattemptsreport a[href*="user/view.php"], table.generaltable a[href*="user/view.php"]');if(!userLinks.length)return void _log.default.debug("[AgentDetect Badge] No user links found on overview page.");const userMap=new Map;if(userLinks.forEach((link=>{const url=new URL(link.href,window.location.origin),uid=parseInt(url.searchParams.get("id"),10);uid&&!isNaN(uid)&&(userMap.has(uid)||userMap.set(uid,[]),userMap.get(uid).push(link))})),!userMap.size)return;const userIds=Array.from(userMap.keys());_log.default.debug("[AgentDetect Badge] Fetching flags for",userIds.length,"users");try{(await fetchFlags(userIds,config.contextid)).forEach((flag=>{const links=userMap.get(flag.userid);links&&links.length>0&&appendBadge(links[0],flag,config)}))}catch(err){_log.default.error("[AgentDetect Badge] Failed to fetch flags:",err)}},injectReviewBadge=async config=>{const summaryTable=document.querySelector("table.quizreviewsummary");if(!summaryTable)return void _log.default.debug("[AgentDetect Badge] No quiz review summary table found.");const userLink=summaryTable.querySelector('a[href*="user/view.php"]');if(!userLink)return;const url=new URL(userLink.href,window.location.origin),uid=parseInt(url.searchParams.get("id"),10);if(uid&&!isNaN(uid))try{const flags=await fetchFlags([uid],config.contextid);flags.length>0&&appendBadge(userLink,flags[0],config)}catch(err){_log.default.error("[AgentDetect Badge] Failed to fetch flag:",err)}},fetchFlags=(userIds,contextId)=>_ajax.default.call([{methodname:"local_agentdetect_get_user_flags",args:{userids:userIds,contextid:contextId}}])[0],appendBadge=(link,flag,config)=>{if(link.parentElement.querySelector(".agentdetect-badge"))return;let iconName,cssClass,tooltip;if("agent_suspected"===flag.flagtype||"agent_confirmed"===flag.flagtype)iconName="i/warning",cssClass="agentdetect-badge text-danger",tooltip=flag.flagtype.replace("_"," ")+" (score: "+flag.maxscore+")";else if("low_suspicion"===flag.flagtype)iconName="i/flagged",cssClass="agentdetect-badge text-warning",tooltip="Low suspicion (score: "+flag.maxscore+")";else{if("likely_human"!==flag.flagtype)return;iconName="i/checkedcircle",cssClass="agentdetect-badge text-success",tooltip="Likely human (score: "+flag.maxscore+")"}const reportUrl=config.reportUrl+"&userid="+flag.userid,badgeLink=document.createElement("a");badgeLink.href=reportUrl,badgeLink.className=cssClass,badgeLink.title=tooltip,badgeLink.style.marginLeft="4px",badgeLink.style.textDecoration="none";const img=document.createElement("img");img.src=M.util.image_url(iconName,"core"),img.alt=tooltip,img.className="icon",img.style.width="16px",img.style.height="16px",badgeLink.appendChild(img),link.parentElement.insertBefore(badgeLink,link.nextSibling)}}));

//# sourceMappingURL=quiz_badge.min.js.map