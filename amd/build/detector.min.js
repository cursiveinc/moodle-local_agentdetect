define("local_agentdetect/detector",["exports","local_agentdetect/fingerprint","local_agentdetect/interaction","local_agentdetect/injection","core/ajax","core/log"],(function(_exports,Fingerprint,Interaction,Injection,_ajax,_log){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Main agent detection module.
   *
   * Orchestrates fingerprint and interaction detection, combines results,
   * and reports to the Moodle backend.
   *
   * @module     local_agentdetect/detector
   * @copyright  2024 Your Institution
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.shutdown=_exports.runAnalysis=_exports.init=_exports.getStatus=_exports.default=_exports.collectAndReport=void 0,Fingerprint=_interopRequireWildcard(Fingerprint),Interaction=_interopRequireWildcard(Interaction),Injection=_interopRequireWildcard(Injection),_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log);let config={enabled:!0,reportInterval:3e4,minReportScore:10,contextId:null,sessionKey:null,debug:!1},reportTimer=null,sessionId=null;let initialized=!1;const init=async function(){let options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(initialized)return void _log.default.debug("[AgentDetect] Already initialized");if(config={...config,...options},!config.enabled)return void _log.default.debug("[AgentDetect] Detection disabled");sessionId=restoreOrCreateSessionId(),_log.default.debug("[AgentDetect] Initializing detection",{sessionId:sessionId,config:config}),Interaction.startMonitoring({contextId:config.contextId}),Injection.startMonitoring({debug:config.debug});const initialFingerprint=await Fingerprint.collect();config.debug&&_log.default.debug("[AgentDetect] Initial fingerprint:",initialFingerprint),initialFingerprint.score>=config.minReportScore&&await reportSignals({type:"fingerprint",data:initialFingerprint}),startPeriodicReporting(),window.addEventListener("beforeunload",handlePageUnload),document.addEventListener("visibilitychange",handleVisibilityChange),initialized=!0,_log.default.debug("[AgentDetect] Initialization complete")};_exports.init=init;const restoreOrCreateSessionId=()=>{try{const stored=sessionStorage.getItem("agentdetect_session");if(stored){const parsed=JSON.parse(stored);if(Date.now()-(parsed.timestamp||0)<18e5&&parsed.id)return _log.default.debug("[AgentDetect] Restored session ID from prior page",parsed.id),parsed.id}}catch(e){}const newId=`${Date.now().toString(36)}-${Math.random().toString(36).substring(2,10)}`;try{sessionStorage.setItem("agentdetect_session",JSON.stringify({id:newId,timestamp:Date.now()}))}catch(e){}return newId},startPeriodicReporting=()=>{reportTimer&&clearInterval(reportTimer),reportTimer=setInterval((async()=>{await collectAndReport()}),config.reportInterval)},collectAndReport=async()=>{const fingerprint=await Fingerprint.collect(),interaction=Interaction.analyze(),injection=Injection.analyze(),comet=extractCometSignals(fingerprint,interaction,injection),combinedScore=calculateCombinedScore(fingerprint.score,interaction.score,injection.score,comet.score),result={sessionId:sessionId,timestamp:Date.now(),pageUrl:window.location.href,pageTitle:document.title,fingerprint:fingerprint,interaction:interaction,injection:injection,comet:comet,combinedScore:combinedScore,verdict:getVerdict(combinedScore),detectedAgent:comet.detected?"comet_agentic":null};return config.debug&&_log.default.debug("[AgentDetect] Analysis result:",result),combinedScore>=config.minReportScore&&await reportSignals({type:"combined",data:result}),result};_exports.collectAndReport=collectAndReport;const calculateCombinedScore=function(fingerprintScore,interactionScore){let injectionScore=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,cometScore=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,score=interactionScore;return injectionScore>=50?score=Math.min(100,score+25):injectionScore>=25?score=Math.min(100,score+15):injectionScore>=10&&(score=Math.min(100,score+5)),fingerprintScore>=70?score=Math.min(100,score+30):fingerprintScore>=40?score=Math.min(100,score+15):fingerprintScore>=20&&(score=Math.min(100,score+5)),cometScore>=70?(score=Math.max(score,80),score=Math.min(100,score+10)):cometScore>=40?score=Math.min(100,score+15):cometScore>=20&&(score=Math.min(100,score+5)),Math.round(score)},extractCometSignals=(fingerprint,interaction,injection)=>{var _fingerprint$webdrive;const signals=[];fingerprint.cometExtension&&signals.push(...fingerprint.cometExtension.signals||[]),fingerprint.cometRuntime&&signals.push(...fingerprint.cometRuntime.signals||[]),fingerprint.perplexityNetwork&&signals.push(...fingerprint.perplexityNetwork.signals||[]);const webdriverChange=((null===(_fingerprint$webdrive=fingerprint.webdriver)||void 0===_fingerprint$webdrive?void 0:_fingerprint$webdrive.signals)||[]).find((s=>"webdriver.changed_mid_session"===s.name));webdriverChange&&signals.push(webdriverChange);const cometAnomalies=(interaction.anomalies||[]).filter((a=>a.name.startsWith("comet.")));signals.push(...cometAnomalies);const cometInjections=(injection.signals||[]).filter((s=>s.name.includes("comet")||s.name.includes("perplexity")||s.name.includes("npclhjbddhklpbnacpjloidibaggcgon")));return signals.push(...cometInjections),{detected:signals.length>0,signalCount:signals.length,signals:signals,score:calculateCometScore(signals)}},calculateCometScore=signals=>{if(0===signals.length)return 0;const totalWeight=signals.reduce(((sum,s)=>sum+(s.weight||s.maxWeight||0)),0);if(signals.some((s=>"comet_overlay_js"===s.name||"comet.extension.script_injected"===s.name||"comet.extension.resource_probe"===s.name||"comet_agent_src"===s.name||"network.perplexity_agent"===s.name||s.name.startsWith("comet.runtime."))))return Math.min(100,70+totalWeight);const TIER1_NAMES=["comet.ultra_precise_center","comet.low_mouse_to_action_ratio"],tier1=signals.filter((s=>TIER1_NAMES.includes(s.name)&&s.weight>=10)),tier2=signals.filter((s=>s.name.startsWith("comet.")&&!tier1.includes(s)));return tier1.length>=1&&tier2.length>=2?Math.min(100,2*totalWeight):tier1.length>=1?Math.min(100,Math.round(1.5*totalWeight)):Math.min(40,totalWeight)},getVerdict=score=>score>=80?"HIGH_CONFIDENCE_AGENT":score>=60?"PROBABLE_AGENT":score>=40?"SUSPICIOUS":score>=20?"LOW_SUSPICION":"LIKELY_HUMAN",reportSignals=async payload=>{if(config.sessionKey)try{const response=await _ajax.default.call([{methodname:"local_agentdetect_report_signals",args:{sesskey:config.sessionKey,contextid:config.contextId,sessionid:sessionId,signaltype:payload.type,signaldata:JSON.stringify(payload.data)}}])[0];config.debug&&_log.default.debug("[AgentDetect] Report response:",response)}catch(error){_log.default.error("[AgentDetect] Failed to report signals:",error)}else _log.default.warn("[AgentDetect] No session key configured, skipping report")},handlePageUnload=()=>{if(Interaction.saveToSessionStorage(),navigator.sendBeacon&&config.sessionKey){const interaction=Interaction.analyze(),payload={sesskey:config.sessionKey,contextid:config.contextId,sessionid:sessionId,signaltype:"unload",signaldata:JSON.stringify({pageUrl:window.location.href,pageTitle:document.title,interaction:interaction,duration:Date.now()-(Interaction.getRawData().startTime||Date.now())})},url=M.cfg.wwwroot+"/local/agentdetect/beacon.php";navigator.sendBeacon(url,JSON.stringify(payload))}},handleVisibilityChange=async()=>{"hidden"===document.visibilityState&&await collectAndReport()},runAnalysis=async()=>await collectAndReport();_exports.runAnalysis=runAnalysis;const getStatus=()=>({initialized:initialized,sessionId:sessionId,isMonitoring:Interaction.getRawData().isMonitoring,config:{enabled:config.enabled,reportInterval:config.reportInterval,minReportScore:config.minReportScore}});_exports.getStatus=getStatus;const shutdown=()=>{reportTimer&&(clearInterval(reportTimer),reportTimer=null),Interaction.stopMonitoring(),Injection.stopMonitoring(),window.removeEventListener("beforeunload",handlePageUnload),document.removeEventListener("visibilitychange",handleVisibilityChange),initialized=!1,_log.default.debug("[AgentDetect] Shutdown complete")};_exports.shutdown=shutdown;var _default={init:init,runAnalysis:runAnalysis,getStatus:getStatus,shutdown:shutdown,collectAndReport:collectAndReport};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=detector.min.js.map