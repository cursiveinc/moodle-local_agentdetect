define("local_agentdetect/injection",["exports","core/log"],(function(_exports,_log){var obj;
/**
   * Injection detection module.
   *
   * Uses MutationObserver to detect elements injected by browser extensions,
   * particularly AI helper tools, homework solvers, and answer providers.
   *
   * This catches human-driven AI assistance where students use extension UI
   * (sidebars, "solve" buttons, floating helpers) rather than automated agents.
   *
   * @module     local_agentdetect/injection
   * @copyright  2024 Your Institution
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.stopMonitoring=_exports.startMonitoring=_exports.reset=_exports.getRawData=_exports.default=_exports.analyze=void 0,_log=(obj=_log)&&obj.__esModule?obj:{default:obj};const SUSPICIOUS_TEXT_PATTERNS=[{pattern:/\b(get\s+answer|show\s+answer|reveal\s+answer|find\s+answer)\b/i,name:"get_answer",weight:9},{pattern:/\b(solve\s+this|solve\s+for\s+me|auto\s*solve)\b/i,name:"solve_button",weight:8},{pattern:/\b(step.by.step\s+solution)\b/i,name:"explain_button",weight:6},{pattern:/\b(ask\s+(ai|gpt|chatgpt|claude|copilot|gemini|bard))\b/i,name:"ask_ai",weight:9},{pattern:/\b(ai\s+(help|assist|tutor|helper))\b/i,name:"ai_help",weight:8},{pattern:/\b(generate\s+answer|write\s+for\s+me|ai\s+write)\b/i,name:"generate",weight:7},{pattern:/\b(chegg|course\s*hero|brainly|bartleby|studocu)\b/i,name:"known_service",weight:10},{pattern:/\b(symbolab|mathway|photomath|wolfram\s*alpha)\b/i,name:"math_solver",weight:8},{pattern:/\b(quillbot|scribbr)\b/i,name:"writing_helper",weight:5}],SUSPICIOUS_ELEMENT_PATTERNS=[{pattern:/^chatgpt/i,attribute:"class",name:"chatgpt_class",weight:9},{pattern:/^chatgpt/i,attribute:"id",name:"chatgpt_id",weight:9},{pattern:/^openai/i,attribute:"class",name:"openai_class",weight:9},{pattern:/^openai/i,attribute:"id",name:"openai_id",weight:9},{pattern:/^gpt-/i,attribute:"class",name:"gpt_class",weight:9},{pattern:/^claude-/i,attribute:"class",name:"claude_class",weight:9},{pattern:/^gemini-/i,attribute:"class",name:"gemini_class",weight:9},{pattern:/^chegg/i,attribute:"class",name:"chegg",weight:10},{pattern:/^chegg/i,attribute:"id",name:"chegg",weight:10},{pattern:/^brainly/i,attribute:"class",name:"brainly",weight:10},{pattern:/^brainly/i,attribute:"id",name:"brainly",weight:10},{pattern:/^coursehero/i,attribute:"class",name:"coursehero",weight:10},{pattern:/^quizlet/i,attribute:"class",name:"quizlet",weight:8},{pattern:/^bartleby/i,attribute:"class",name:"bartleby",weight:10},{pattern:/^studocu/i,attribute:"class",name:"studocu",weight:10},{pattern:/^comet/i,attribute:"class",name:"comet_class",weight:9},{pattern:/^comet/i,attribute:"id",name:"comet_id",weight:9},{pattern:/^perplexity/i,attribute:"class",name:"perplexity_class",weight:9},{pattern:/^perplexity/i,attribute:"id",name:"perplexity_id",weight:9},{pattern:/npclhjbddhklpbnacpjloidibaggcgon/,attribute:"src",name:"comet_agent_src",weight:10},{pattern:/npclhjbddhklpbnacpjloidibaggcgon/,attribute:"href",name:"comet_agent_href",weight:10},{pattern:/chrome-extension:\/\//i,attribute:"src",name:"chrome_ext_src",weight:7},{pattern:/moz-extension:\/\//i,attribute:"src",name:"moz_ext_src",weight:7}],FLOATING_UI_INDICATORS={positions:["fixed","absolute"],minSize:50,maxZIndex:9e3},detectionStore={injectedElements:[],suspiciousText:[],floatingUI:[],chromeExtensionResources:[],startTime:Date.now()};let observer=null,isMonitoring=!1,debugMode=!1;const startMonitoring=function(){let options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};isMonitoring||(debugMode=options.debug||!1,isMonitoring=!0,detectionStore.startTime=Date.now(),scanExistingDOM(),observer=new MutationObserver(handleMutations),observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","id","src","style"]}),debugMode&&_log.default.debug("[AgentDetect/Injection] Monitoring started"))};_exports.startMonitoring=startMonitoring;const stopMonitoring=()=>{isMonitoring&&(observer&&(observer.disconnect(),observer=null),isMonitoring=!1,debugMode&&_log.default.debug("[AgentDetect/Injection] Monitoring stopped"))};_exports.stopMonitoring=stopMonitoring;const scanExistingDOM=()=>{const allElements=document.body.querySelectorAll("*");for(const element of allElements)analyzeElement(element,"initial_scan");scanExtensionResources(),debugMode&&_log.default.debug("[AgentDetect/Injection] Initial scan complete",{injectedElements:detectionStore.injectedElements.length,suspiciousText:detectionStore.suspiciousText.length,floatingUI:detectionStore.floatingUI.length})},handleMutations=mutations=>{for(const mutation of mutations)if("childList"===mutation.type){for(const node of mutation.addedNodes)if(node.nodeType===Node.ELEMENT_NODE){analyzeElement(node,"mutation_added"),"SCRIPT"===node.tagName&&node.src&&node.src.includes("npclhjbddhklpbnacpjloidibaggcgon")&&(detectionStore.injectedElements.push({timestamp:Date.now(),source:"comet_overlay_injection",tagName:"SCRIPT",id:null,className:null,findings:[{type:"comet_agentic",name:"comet_overlay_js",value:node.src,weight:10}]}),debugMode&&_log.default.debug("[AgentDetect/Injection] Comet overlay.js injected",node.src));const children=node.querySelectorAll?node.querySelectorAll("*"):[];for(const child of children)analyzeElement(child,"mutation_added_child")}}else"attributes"===mutation.type&&analyzeElement(mutation.target,"mutation_attribute")},analyzeElement=(element,source)=>{var _element$textContent;if(!element||!element.tagName)return;if(isMoodleElement(element))return;const findings=[];for(const pattern of SUSPICIOUS_ELEMENT_PATTERNS){const attrValue=element.getAttribute(pattern.attribute);attrValue&&pattern.pattern.test(attrValue)&&findings.push({type:"element_pattern",name:pattern.name,attribute:pattern.attribute,value:attrValue,weight:pattern.weight})}const textContent=(null===(_element$textContent=element.textContent)||void 0===_element$textContent?void 0:_element$textContent.trim().substring(0,200))||"";if(textContent&&0===element.children.length)for(const pattern of SUSPICIOUS_TEXT_PATTERNS)pattern.pattern.test(textContent)&&findings.push({type:"text_pattern",name:pattern.name,text:textContent.substring(0,50),weight:pattern.weight});const floatingInfo=checkFloatingUI(element);if(floatingInfo&&findings.push({type:"floating_ui",name:"injected_overlay",...floatingInfo,weight:6}),element.shadowRoot&&findings.push({type:"shadow_dom",name:"injected_shadow_root",weight:7}),findings.length>0){const detection={timestamp:Date.now(),source:source,tagName:element.tagName,id:element.id||null,className:element.className||null,findings:findings};detectionStore.injectedElements.push(detection),debugMode&&_log.default.debug("[AgentDetect/Injection] Suspicious element detected",detection)}},checkFloatingUI=element=>{const style=window.getComputedStyle(element),position=style.position;if(!FLOATING_UI_INDICATORS.positions.includes(position))return null;const rect=element.getBoundingClientRect(),zIndex=parseInt(style.zIndex,10)||0;return rect.width<FLOATING_UI_INDICATORS.minSize||rect.height<FLOATING_UI_INDICATORS.minSize?null:zIndex>=FLOATING_UI_INDICATORS.maxZIndex?{position:position,zIndex:zIndex,width:rect.width,height:rect.height}:null},isMoodleElement=element=>{var _element$className;const className=(null===(_element$className=element.className)||void 0===_element$className?void 0:_element$className.toString())||"",id=element.id||"",moodlePatterns=[/^(mod-|block-|course-|quiz-|assign-|forum-|page-)/i,/^(moodle|mdl-|m-)/i,/^(nav|navbar|footer|header|drawer)/i,/^(activity|section|content)/i,/^(user|profile|grade)/i,/^(btn|alert|card|modal|dropdown|collapse|form-|input-|list-)/i,/^(container|row|col-|d-|p-|m-|text-|bg-|border-)/i,/^(fa-|fa |fas |far |fab |icon)/i,/^(tox-|tox |mce-|tiny)/i,/^(que|qn|answer|formulation|outcome|feedback|rightanswer)/i,/^(submitbtns|im-controls)/i,/^(atto|editor_atto)/i,/^(yui|yui3)/i];for(const pattern of moodlePatterns)if(pattern.test(className)||pattern.test(id))return!0;return!!(element.hasAttribute("data-region")||element.hasAttribute("data-action")||element.hasAttribute("data-for")||element.hasAttribute("data-contextid"))},scanExtensionResources=()=>{const images=document.querySelectorAll('img[src^="chrome-extension://"], img[src^="moz-extension://"]');for(const img of images)detectionStore.chromeExtensionResources.push({type:"image",src:img.src,timestamp:Date.now()});const iframes=document.querySelectorAll('iframe[src^="chrome-extension://"], iframe[src^="moz-extension://"]');for(const iframe of iframes)detectionStore.chromeExtensionResources.push({type:"iframe",src:iframe.src,timestamp:Date.now()});for(const sheet of document.styleSheets)try{sheet.href&&(sheet.href.startsWith("chrome-extension://")||sheet.href.startsWith("moz-extension://"))&&detectionStore.chromeExtensionResources.push({type:"stylesheet",src:sheet.href,timestamp:Date.now()})}catch(e){}},analyze=()=>{const results={timestamp:Date.now(),duration:Date.now()-detectionStore.startTime,detectionCounts:{injectedElements:detectionStore.injectedElements.length,extensionResources:detectionStore.chromeExtensionResources.length},signals:[],score:0},signalMap=new Map;for(const detection of detectionStore.injectedElements)for(const finding of detection.findings){const key=`${finding.type}.${finding.name}`;signalMap.has(key)||signalMap.set(key,{name:key,count:0,maxWeight:finding.weight,examples:[]});const signal=signalMap.get(key);signal.count++,signal.maxWeight=Math.max(signal.maxWeight,finding.weight),signal.examples.length<3&&signal.examples.push(finding.text||finding.value||detection.tagName)}return detectionStore.chromeExtensionResources.length>0&&signalMap.set("extension.resources",{name:"extension.resources",count:detectionStore.chromeExtensionResources.length,maxWeight:7,examples:detectionStore.chromeExtensionResources.slice(0,3).map((r=>r.type))}),results.signals=Array.from(signalMap.values()),results.score=calculateInjectionScore(results.signals),results};_exports.analyze=analyze;const calculateInjectionScore=signals=>{if(0===signals.length)return 0;let totalWeight=0;for(const signal of signals){const countMultiplier=Math.min(signal.count,5);totalWeight+=signal.maxWeight*(1+.2*(countMultiplier-1))}const normalized=totalWeight/50*100;return Math.min(100,Math.round(normalized))},getRawData=()=>({...detectionStore,isMonitoring:isMonitoring});_exports.getRawData=getRawData;const reset=()=>{detectionStore.injectedElements=[],detectionStore.suspiciousText=[],detectionStore.floatingUI=[],detectionStore.chromeExtensionResources=[],detectionStore.startTime=Date.now()};_exports.reset=reset;var _default={startMonitoring:startMonitoring,stopMonitoring:stopMonitoring,analyze:analyze,getRawData:getRawData,reset:reset};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=injection.min.js.map