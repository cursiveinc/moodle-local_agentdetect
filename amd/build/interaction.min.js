define("local_agentdetect/interaction",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.stopMonitoring=_exports.startMonitoring=_exports.saveToSessionStorage=_exports.reset=_exports.getRawData=_exports.default=_exports.analyze=void 0;
/**
   * Interaction anomaly detection module.
   *
   * Monitors user interactions (mouse, keyboard, scroll) to detect
   * patterns typical of automated browsers versus human users.
   *
   * @module     local_agentdetect/interaction
   * @copyright  2024 Your Institution
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
const CONFIG={minMouseMoves:20,minClicks:3,minKeystrokes:10,perfectTimingVariance:5,minHumanReactionTime:50,maxMouseSpeed:1e4,centerClickTolerance:5,maxStoredEvents:500,analysisInterval:1e4},eventStore={mouseMoves:[],clicks:[],keystrokes:[],scrolls:[],hovers:[],focusChanges:[],pointerEvents:[],startTime:Date.now(),pageLoadCount:1};let contextId=null,analysisCache=null,isMonitoring=!1;const startMonitoring=function(){let options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};isMonitoring||(isMonitoring=!0,contextId=options.contextId||null,eventStore.startTime=Date.now(),loadFromSessionStorage(),document.addEventListener("mousemove",handleMouseMove,{passive:!0}),document.addEventListener("click",handleClick,{capture:!0,passive:!0}),document.addEventListener("mousedown",handleMouseDown,{capture:!0,passive:!0}),document.addEventListener("mouseup",handleMouseUp,{capture:!0,passive:!0}),document.addEventListener("mouseover",handleMouseOver,{passive:!0}),document.addEventListener("mouseout",handleMouseOut,{passive:!0}),document.addEventListener("keydown",handleKeyDown,{capture:!0,passive:!0}),document.addEventListener("keyup",handleKeyUp,{capture:!0,passive:!0}),document.addEventListener("scroll",handleScroll,{passive:!0}),window.addEventListener("scroll",handleScroll,{passive:!0}),document.addEventListener("focusin",handleFocusIn,{passive:!0}),document.addEventListener("focusout",handleFocusOut,{passive:!0}),document.addEventListener("pointerdown",handlePointerDown,{capture:!0,passive:!0}),document.addEventListener("pointermove",handlePointerMove,{passive:!0}))};_exports.startMonitoring=startMonitoring;const stopMonitoring=()=>{isMonitoring&&(isMonitoring=!1,document.removeEventListener("mousemove",handleMouseMove),document.removeEventListener("click",handleClick,{capture:!0}),document.removeEventListener("mousedown",handleMouseDown,{capture:!0}),document.removeEventListener("mouseup",handleMouseUp,{capture:!0}),document.removeEventListener("mouseover",handleMouseOver),document.removeEventListener("mouseout",handleMouseOut),document.removeEventListener("keydown",handleKeyDown,{capture:!0}),document.removeEventListener("keyup",handleKeyUp,{capture:!0}),document.removeEventListener("scroll",handleScroll),window.removeEventListener("scroll",handleScroll),document.removeEventListener("focusin",handleFocusIn),document.removeEventListener("focusout",handleFocusOut),document.removeEventListener("pointerdown",handlePointerDown,{capture:!0}),document.removeEventListener("pointermove",handlePointerMove))};_exports.stopMonitoring=stopMonitoring;const handleMouseMove=e=>{const now=Date.now(),lastMove=eventStore.mouseMoves[eventStore.mouseMoves.length-1],moveData={x:e.clientX,y:e.clientY,timestamp:now,deltaTime:lastMove?now-lastMove.timestamp:0,deltaX:lastMove?e.clientX-lastMove.x:0,deltaY:lastMove?e.clientY-lastMove.y:0};if(moveData.deltaTime>0){const distance=Math.sqrt(moveData.deltaX**2+moveData.deltaY**2);moveData.velocity=distance/moveData.deltaTime}addToStore("mouseMoves",moveData)},handleClick=e=>{const now=Date.now(),target=e.target,rect=target.getBoundingClientRect(),elementCenterX=rect.left+rect.width/2,elementCenterY=rect.top+rect.height/2,offsetFromCenter=Math.sqrt((e.clientX-elementCenterX)**2+(e.clientY-elementCenterY)**2),clickData={x:e.clientX,y:e.clientY,timestamp:now,target:{tagName:target.tagName,id:target.id,className:target.className,width:rect.width,height:rect.height},offsetFromCenter:offsetFromCenter,hadPrecedingHover:checkPrecedingHover(target),hadPrecedingMouseMove:checkPrecedingMouseMove(e.clientX,e.clientY)};addToStore("clicks",clickData)},handleMouseDown=()=>{const lastClick=eventStore.clicks[eventStore.clicks.length-1];lastClick&&!lastClick.mousedownTime&&(lastClick.mousedownTime=Date.now())},handleMouseUp=()=>{const lastClick=eventStore.clicks[eventStore.clicks.length-1];lastClick&&lastClick.mousedownTime&&(lastClick.clickDuration=Date.now()-lastClick.mousedownTime)},handleMouseOver=e=>{addToStore("hovers",{target:e.target,timestamp:Date.now(),type:"over"})},handleMouseOut=e=>{addToStore("hovers",{target:e.target,timestamp:Date.now(),type:"out"})},handleKeyDown=e=>{const now=Date.now(),lastKeystroke=eventStore.keystrokes[eventStore.keystrokes.length-1];addToStore("keystrokes",{key:1===e.key.length?"char":e.key,timestamp:now,deltaTime:lastKeystroke?now-lastKeystroke.timestamp:0,type:"down"})},handleKeyUp=()=>{const keydowns=eventStore.keystrokes.filter((k=>"down"===k.type&&!k.holdDuration)),matchingKeydown=keydowns[keydowns.length-1];matchingKeydown&&(matchingKeydown.holdDuration=Date.now()-matchingKeydown.timestamp)},handleScroll=()=>{const now=Date.now(),lastScroll=eventStore.scrolls[eventStore.scrolls.length-1];addToStore("scrolls",{scrollY:window.scrollY,scrollX:window.scrollX,timestamp:now,deltaTime:lastScroll?now-lastScroll.timestamp:0,deltaY:lastScroll?window.scrollY-lastScroll.scrollY:0,deltaX:lastScroll?window.scrollX-lastScroll.scrollX:0})},handleFocusIn=e=>{addToStore("focusChanges",{target:{tagName:e.target.tagName,id:e.target.id,type:e.target.type},timestamp:Date.now(),type:"in"})},handleFocusOut=e=>{addToStore("focusChanges",{target:{tagName:e.target.tagName,id:e.target.id,type:e.target.type},timestamp:Date.now(),type:"out"})},handlePointerDown=e=>{addToStore("pointerEvents",{type:"down",x:e.clientX,y:e.clientY,timestamp:Date.now(),pointerType:e.pointerType})},handlePointerMove=e=>{const now=Date.now(),last=eventStore.pointerEvents[eventStore.pointerEvents.length-1];last&&now-last.timestamp<50||addToStore("pointerEvents",{type:"move",x:e.clientX,y:e.clientY,timestamp:now,pointerType:e.pointerType})};let lastPeriodicSave=0;const addToStore=(storeName,data)=>{eventStore[storeName].push(data),eventStore[storeName].length>CONFIG.maxStoredEvents&&eventStore[storeName].shift(),analysisCache=null;const now=Date.now();if(now-lastPeriodicSave>2e3){lastPeriodicSave=now;try{saveToSessionStorage()}catch(e){}}},checkPrecedingHover=target=>eventStore.hovers.slice(-20).some((h=>h.target===target&&"over"===h.type)),checkPrecedingMouseMove=(x,y)=>{const recentMoves=eventStore.mouseMoves.slice(-10);return 0!==recentMoves.length&&recentMoves.some((m=>Math.sqrt((m.x-x)**2+(m.y-y)**2)<50))},analyze=()=>{if(analysisCache)return analysisCache;const results={timestamp:Date.now(),duration:Date.now()-eventStore.startTime,pageLoadCount:eventStore.pageLoadCount,eventCounts:{mouseMoves:eventStore.mouseMoves.length,clicks:eventStore.clicks.length,keystrokes:eventStore.keystrokes.length,scrolls:eventStore.scrolls.length,hovers:eventStore.hovers.length,focusChanges:eventStore.focusChanges.length,pointerEvents:eventStore.pointerEvents.length},anomalies:[],score:0};return results.anomalies.push(...analyzeMouseMovement()),results.anomalies.push(...analyzeClicks()),results.anomalies.push(...analyzeKeystrokes()),results.anomalies.push(...analyzeScrolling()),results.anomalies.push(...analyzeEventSequence()),results.anomalies.push(...analyzeActionBursts()),results.anomalies.push(...analyzeCDPClickPatterns()),results.anomalies.push(...analyzePointerEvents()),results.score=calculateInteractionScore(results.anomalies),analysisCache=results,results};_exports.analyze=analyze;const analyzeMouseMovement=()=>{const anomalies=[],moves=eventStore.mouseMoves;if(moves.length<CONFIG.minMouseMoves)return anomalies.push({name:"mouse.insufficient_data",value:moves.length,weight:2}),anomalies;const linearSegments=findLinearSegments(moves);linearSegments>.3*moves.length&&anomalies.push({name:"mouse.linear_movement",value:linearSegments/moves.length,weight:3});const teleports=moves.filter((m=>m.velocity>CONFIG.maxMouseSpeed));teleports.length>0&&anomalies.push({name:"mouse.teleport",value:teleports.length,weight:8});const duration=Date.now()-eventStore.startTime;moves.length<duration/5e3&&anomalies.push({name:"mouse.sparse_movement",value:moves.length,weight:5});const velocities=moves.filter((m=>m.velocity)).map((m=>m.velocity));if(velocities.length>5){const variance=calculateVariance(velocities);variance<.1&&anomalies.push({name:"mouse.constant_velocity",value:variance,weight:6})}const totalClicks=eventStore.clicks.length;if(totalClicks>=3&&eventStore.pageLoadCount>=2){const movePerClick=moves.length/totalClicks;movePerClick<2?anomalies.push({name:"comet.low_mouse_to_action_ratio",value:movePerClick,weight:10}):movePerClick<5&&anomalies.push({name:"comet.low_mouse_to_action_ratio",value:movePerClick,weight:5})}return anomalies},findLinearSegments=moves=>{let linearCount=0;for(let i=2;i<moves.length;i++){const angle1=Math.atan2(moves[i-1].y-moves[i-2].y,moves[i-1].x-moves[i-2].x),angle2=Math.atan2(moves[i].y-moves[i-1].y,moves[i].x-moves[i-1].x);Math.abs(Math.cos(angle1-angle2))>.99&&linearCount++}return linearCount},analyzeClicks=()=>{const anomalies=[],clicks=eventStore.clicks;if(clicks.length<CONFIG.minClicks)return anomalies;const centerClicks=clicks.filter((c=>c.offsetFromCenter<CONFIG.centerClickTolerance));centerClicks.length>.5*clicks.length&&anomalies.push({name:"click.center_precision",value:centerClicks.length/clicks.length,weight:10});const ultraPreciseClicks=clicks.filter((c=>c.offsetFromCenter<2));ultraPreciseClicks.length>.6*clicks.length&&clicks.length>=3&&anomalies.push({name:"comet.ultra_precise_center",value:ultraPreciseClicks.length/clicks.length,weight:10});const noHoverClicks=clicks.filter((c=>!c.hadPrecedingHover));noHoverClicks.length>.7*clicks.length&&anomalies.push({name:"click.no_hover",value:noHoverClicks.length/clicks.length,weight:6});const noMoveClicks=clicks.filter((c=>!c.hadPrecedingMouseMove));noMoveClicks.length>.5*clicks.length&&anomalies.push({name:"click.no_movement",value:noMoveClicks.length/clicks.length,weight:9});const totalMouseMoves=eventStore.mouseMoves.length;clicks.length>=3&&totalMouseMoves<2*clicks.length&&anomalies.push({name:"click.teleport_pattern",value:totalMouseMoves/clicks.length,weight:10});const interClickTimes=[];for(let i=1;i<clicks.length;i++)interClickTimes.push(clicks[i].timestamp-clicks[i-1].timestamp);const fastClicks=interClickTimes.filter((t=>t<CONFIG.minHumanReactionTime));if(fastClicks.length>0&&anomalies.push({name:"click.superhuman_speed",value:fastClicks.length,weight:3}),interClickTimes.length>=3){const variance=calculateVariance(interClickTimes);variance<CONFIG.perfectTimingVariance&&anomalies.push({name:"click.perfect_timing",value:variance,weight:8})}return anomalies},analyzeKeystrokes=()=>{const anomalies=[],keystrokes=eventStore.keystrokes.filter((k=>"down"===k.type));if(keystrokes.length<CONFIG.minKeystrokes)return anomalies;const interKeyTimes=keystrokes.slice(1).map((k=>k.deltaTime));if(interKeyTimes.length>=5){const variance=calculateVariance(interKeyTimes);variance<CONFIG.perfectTimingVariance&&anomalies.push({name:"keystroke.perfect_timing",value:variance,weight:9})}const keyMean=interKeyTimes.reduce(((a,b)=>a+b),0)/interKeyTimes.length,keyStdDev=Math.sqrt(calculateVariance(interKeyTimes)),keyCV=keyMean>0?keyStdDev/keyMean:0;keyCV<.1&&interKeyTimes.length>=10&&anomalies.push({name:"comet.uniform_keystroke_cadence",value:keyCV,weight:9});const fastKeys=interKeyTimes.filter((t=>t>0&&t<30));fastKeys.length>.3*interKeyTimes.length&&anomalies.push({name:"keystroke.superhuman_speed",value:fastKeys.length/interKeyTimes.length,weight:9});const holdDurations=keystrokes.filter((k=>k.holdDuration)).map((k=>k.holdDuration));if(holdDurations.length>=5){const variance=calculateVariance(holdDurations);if(variance<1&&anomalies.push({name:"keystroke.constant_hold",value:variance,weight:7}),holdDurations.length>=10){const holdMean=holdDurations.reduce(((a,b)=>a+b),0)/holdDurations.length,holdStdDev=Math.sqrt(calculateVariance(holdDurations)),holdCV=holdMean>0?holdStdDev/holdMean:0;holdCV<.1&&anomalies.push({name:"comet.uniform_hold_duration",value:holdCV,weight:8})}}return anomalies},analyzeScrolling=()=>{const anomalies=[],scrolls=eventStore.scrolls;if(scrolls.length<3)return anomalies;const instantScrolls=scrolls.filter((s=>s.deltaTime<10&&Math.abs(s.deltaY)>100));instantScrolls.length>.5*scrolls.length&&anomalies.push({name:"scroll.instant_jump",value:instantScrolls.length/scrolls.length,weight:6});const scrollAmounts=scrolls.map((s=>Math.abs(s.deltaY))).filter((v=>v>0));if(scrollAmounts.length>=3){const variance=calculateVariance(scrollAmounts);variance<1&&anomalies.push({name:"scroll.constant_amount",value:variance,weight:5})}return anomalies},analyzeEventSequence=()=>{const anomalies=[],hoverRatio=eventStore.hovers.length/Math.max(eventStore.clicks.length,1);hoverRatio<2&&eventStore.clicks.length>=CONFIG.minClicks&&anomalies.push({name:"sequence.low_hover_ratio",value:hoverRatio,weight:5});const directFocus=eventStore.focusChanges.filter((f=>![...eventStore.clicks.slice(-5),...eventStore.keystrokes.slice(-5)].some((e=>Math.abs(e.timestamp-f.timestamp)<100))));directFocus.length>.5*eventStore.focusChanges.length&&eventStore.focusChanges.length>=3&&anomalies.push({name:"sequence.direct_focus",value:directFocus.length/eventStore.focusChanges.length,weight:3});const focusIns=eventStore.focusChanges.filter((f=>"in"===f.type));if(focusIns.length>=3){let rapidSequentialFocus=0;for(let j=1;j<focusIns.length;j++){const gap=focusIns[j].timestamp-focusIns[j-1].timestamp,differentTarget=focusIns[j].target.id!==focusIns[j-1].target.id;gap<200&&differentTarget&&rapidSequentialFocus++}rapidSequentialFocus>=4&&anomalies.push({name:"comet.rapid_focus_sequence",value:rapidSequentialFocus,weight:5})}return anomalies},calculateVariance=arr=>{if(arr.length<2)return 0;const mean=arr.reduce(((a,b)=>a+b),0)/arr.length;return arr.map((value=>Math.pow(value-mean,2))).reduce(((a,b)=>a+b),0)/arr.length},calculateInteractionScore=anomalies=>{if(0===anomalies.length)return 0;const totalWeight=anomalies.reduce(((sum,a)=>sum+(a.weight||0)),0),maxPossibleWeight=10*anomalies.length,hasCenterPrecision=anomalies.some((a=>"click.center_precision"===a.name)),hasTeleport=anomalies.some((a=>"click.teleport_pattern"===a.name)),hasNoMovement=anomalies.some((a=>"click.no_movement"===a.name)),hasUltraPrecise=anomalies.some((a=>"comet.ultra_precise_center"===a.name)),hasLowMouseRatio=anomalies.some((a=>"comet.low_mouse_to_action_ratio"===a.name&&a.weight>=10));let multiplier=1;const strongSignals=[hasCenterPrecision,hasTeleport,hasNoMovement,hasUltraPrecise,hasLowMouseRatio].filter(Boolean).length;strongSignals>=3?multiplier=1.5:strongSignals>=2&&(multiplier=1.25);let rawScore=totalWeight/Math.max(maxPossibleWeight,30)*100*multiplier;const totalEvents=eventStore.clicks.length+eventStore.keystrokes.length+eventStore.mouseMoves.length;if(totalEvents<10){rawScore*=hasCenterPrecision||hasUltraPrecise||hasLowMouseRatio?.7:.3}else totalEvents<25&&(rawScore*=.85);return Math.min(100,Math.round(rawScore))},analyzeActionBursts=()=>{const anomalies=[],allActions=[...eventStore.clicks.map((e=>({timestamp:e.timestamp,actionType:"click"}))),...eventStore.keystrokes.filter((k=>"down"===k.type)).map((e=>({timestamp:e.timestamp,actionType:"keystroke"}))),...eventStore.focusChanges.map((e=>({timestamp:e.timestamp,actionType:"focus"})))].sort(((a,b)=>a.timestamp-b.timestamp));if(allActions.length<5)return anomalies;let burstCount=0,readThenActCount=0,i=0;for(;i<allActions.length;){let windowEnd=i;for(;windowEnd<allActions.length&&allActions[windowEnd].timestamp-allActions[i].timestamp<2e3;)windowEnd++;const burstSize=windowEnd-i,actionTypes=new Set(allActions.slice(i,windowEnd).map((a=>a.actionType)));if(burstSize>=5&&actionTypes.size>=2){if(burstCount++,i>0){allActions[i].timestamp-allActions[i-1].timestamp>=3e3&&readThenActCount++}i=windowEnd}else i++}const pages=Math.max(eventStore.pageLoadCount,1),readActPerPage=readThenActCount/pages;return burstCount/pages>=3&&anomalies.push({name:"comet.action_burst",value:burstCount,weight:5}),readActPerPage>=2&&anomalies.push({name:"comet.read_then_act",value:readThenActCount,weight:5}),anomalies},analyzeCDPClickPatterns=()=>{const anomalies=[],clicks=eventStore.clicks,moves=eventStore.mouseMoves;if(clicks.length<3)return anomalies;const latestMoveTime=moves.length>0?moves[moves.length-1].timestamp:0;let zeroTrailClicks=0,validClicks=0;for(const click of clicks){if(latestMoveTime>0&&click.timestamp<latestMoveTime-3e4)continue;validClicks++;0===moves.filter((m=>m.timestamp>click.timestamp-300&&m.timestamp<click.timestamp)).length&&zeroTrailClicks++}if(validClicks<3)return anomalies;const ratio=zeroTrailClicks/validClicks;return ratio>.85&&anomalies.push({name:"comet.no_mousemove_trail",value:ratio,weight:6}),anomalies},analyzePointerEvents=()=>{const anomalies=[],clicks=eventStore.clicks,pointerDowns=eventStore.pointerEvents.filter((p=>"down"===p.type));if(clicks.length<3)return anomalies;const ratio=pointerDowns.length/clicks.length;return ratio<.3&&anomalies.push({name:"comet.missing_pointer_events",value:ratio,weight:4}),anomalies},getStorageKey=()=>contextId?`agentdetect_events_${contextId}`:"agentdetect_events",loadFromSessionStorage=()=>{try{const stored=sessionStorage.getItem(getStorageKey());if(!stored)return;const data=JSON.parse(stored);data.startTime&&(eventStore.startTime=data.startTime),eventStore.pageLoadCount=(data.pageLoadCount||1)+1;const storeNames=["mouseMoves","clicks","keystrokes","scrolls","focusChanges","pointerEvents"];for(const name of storeNames)data[name]&&Array.isArray(data[name])&&(eventStore[name]=[...data[name],...eventStore[name]],eventStore[name].length>CONFIG.maxStoredEvents&&(eventStore[name]=eventStore[name].slice(-CONFIG.maxStoredEvents)));analysisCache=null}catch(e){}},saveToSessionStorage=()=>{try{const data={startTime:eventStore.startTime,pageLoadCount:eventStore.pageLoadCount,mouseMoves:eventStore.mouseMoves.slice(-200),clicks:eventStore.clicks.slice(-200).map((c=>({x:c.x,y:c.y,timestamp:c.timestamp,offsetFromCenter:c.offsetFromCenter,hadPrecedingHover:c.hadPrecedingHover,hadPrecedingMouseMove:c.hadPrecedingMouseMove,clickDuration:c.clickDuration}))),keystrokes:eventStore.keystrokes.slice(-200).map((k=>({key:k.key,timestamp:k.timestamp,deltaTime:k.deltaTime,type:k.type,holdDuration:k.holdDuration}))),scrolls:eventStore.scrolls.slice(-200),focusChanges:eventStore.focusChanges.slice(-200).map((f=>({target:f.target,timestamp:f.timestamp,type:f.type}))),pointerEvents:(()=>{const downs=eventStore.pointerEvents.filter((p=>"down"===p.type)).slice(-200),remaining=200-downs.length,moves=remaining>0?eventStore.pointerEvents.filter((p=>"down"!==p.type)).slice(-remaining):[];return[...downs,...moves].sort(((a,b)=>a.timestamp-b.timestamp))})()};sessionStorage.setItem(getStorageKey(),JSON.stringify(data))}catch(e){}};_exports.saveToSessionStorage=saveToSessionStorage;const getRawData=()=>({...eventStore,isMonitoring:isMonitoring});_exports.getRawData=getRawData;const reset=()=>{eventStore.mouseMoves=[],eventStore.clicks=[],eventStore.keystrokes=[],eventStore.scrolls=[],eventStore.hovers=[],eventStore.focusChanges=[],eventStore.pointerEvents=[],eventStore.startTime=Date.now(),eventStore.pageLoadCount=1,analysisCache=null};_exports.reset=reset;var _default={startMonitoring:startMonitoring,stopMonitoring:stopMonitoring,analyze:analyze,getRawData:getRawData,reset:reset,saveToSessionStorage:saveToSessionStorage,CONFIG:CONFIG};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=interaction.min.js.map