{"version":3,"file":"quiz_badge.min.js","sources":["../src/quiz_badge.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Quiz badge injection module.\n *\n * Adds visual agent detection indicators next to student names on\n * quiz report overview and quiz review pages.\n *\n * @module     local_agentdetect/quiz_badge\n * @copyright  2026 Cursive Technology <joe@cursivetechnology.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from 'core/ajax';\nimport Log from 'core/log';\n\n/**\n * Initialise badge injection.\n *\n * @param {Object} config Configuration from PHP.\n * @param {string} config.mode Page mode: 'overview' or 'review'.\n * @param {number} config.courseid Course ID.\n * @param {number} config.contextid Context ID for AJAX calls.\n * @param {string} config.reportUrl Base URL for the course report page.\n */\nexport const init = (config) => {\n    Log.debug('[AgentDetect Badge] Initialising with config:', config);\n\n    if (config.mode === 'overview') {\n        injectOverviewBadges(config);\n    } else if (config.mode === 'review') {\n        injectReviewBadge(config);\n    }\n};\n\n/**\n * Inject badges on the quiz grades overview page.\n *\n * Finds all user profile links in the attempts table, extracts user IDs,\n * makes a single batch AJAX call, and appends icons next to flagged users.\n *\n * @param {Object} config Configuration object.\n */\nconst injectOverviewBadges = async(config) => {\n    // Find user profile links in the attempts table.\n    const userLinks = document.querySelectorAll(\n        'table.quizattemptsreport a[href*=\"user/view.php\"], ' +\n        'table.generaltable a[href*=\"user/view.php\"]'\n    );\n\n    if (!userLinks.length) {\n        Log.debug('[AgentDetect Badge] No user links found on overview page.');\n        return;\n    }\n\n    // Extract unique user IDs from href params.\n    const userMap = new Map();\n    userLinks.forEach((link) => {\n        const url = new URL(link.href, window.location.origin);\n        const uid = parseInt(url.searchParams.get('id'), 10);\n        if (uid && !isNaN(uid)) {\n            if (!userMap.has(uid)) {\n                userMap.set(uid, []);\n            }\n            userMap.get(uid).push(link);\n        }\n    });\n\n    if (!userMap.size) {\n        return;\n    }\n\n    const userIds = Array.from(userMap.keys());\n    Log.debug('[AgentDetect Badge] Fetching flags for', userIds.length, 'users');\n\n    try {\n        const flags = await fetchFlags(userIds, config.contextid);\n        flags.forEach((flag) => {\n            const links = userMap.get(flag.userid);\n            if (links && links.length > 0) {\n                // Only badge the first link per user to avoid duplicates across attempt rows.\n                appendBadge(links[0], flag, config);\n            }\n        });\n    } catch (err) {\n        Log.error('[AgentDetect Badge] Failed to fetch flags:', err);\n    }\n};\n\n/**\n * Inject a badge on the single attempt review page.\n *\n * Finds the user link in the quiz review summary table and checks\n * their flag status.\n *\n * @param {Object} config Configuration object.\n */\nconst injectReviewBadge = async(config) => {\n    // Find user link in the review summary table.\n    const summaryTable = document.querySelector('table.quizreviewsummary');\n    if (!summaryTable) {\n        Log.debug('[AgentDetect Badge] No quiz review summary table found.');\n        return;\n    }\n\n    const userLink = summaryTable.querySelector('a[href*=\"user/view.php\"]');\n    if (!userLink) {\n        return;\n    }\n\n    const url = new URL(userLink.href, window.location.origin);\n    const uid = parseInt(url.searchParams.get('id'), 10);\n    if (!uid || isNaN(uid)) {\n        return;\n    }\n\n    try {\n        const flags = await fetchFlags([uid], config.contextid);\n        if (flags.length > 0) {\n            appendBadge(userLink, flags[0], config);\n        }\n    } catch (err) {\n        Log.error('[AgentDetect Badge] Failed to fetch flag:', err);\n    }\n};\n\n/**\n * Fetch user flags via AJAX.\n *\n * @param {number[]} userIds Array of user IDs.\n * @param {number} contextId Context ID.\n * @returns {Promise<Array>} Array of flag objects.\n */\nconst fetchFlags = (userIds, contextId) => {\n    const request = Ajax.call([{\n        methodname: 'local_agentdetect_get_user_flags',\n        args: {\n            userids: userIds,\n            contextid: contextId,\n        },\n    }]);\n    return request[0];\n};\n\n/**\n * Append a detection badge icon next to a user link.\n *\n * @param {HTMLElement} link The user profile link element.\n * @param {Object} flag The flag data.\n * @param {Object} config Configuration with reportUrl and courseid.\n */\nconst appendBadge = (link, flag, config) => {\n    // Don't double-inject.\n    if (link.parentElement.querySelector('.agentdetect-badge')) {\n        return;\n    }\n\n    let iconName;\n    let cssClass;\n    let tooltip;\n\n    if (flag.flagtype === 'agent_suspected' || flag.flagtype === 'agent_confirmed') {\n        iconName = 'i/warning';\n        cssClass = 'agentdetect-badge text-danger';\n        tooltip = flag.flagtype.replace('_', ' ') + ' (score: ' + flag.maxscore + ')';\n    } else if (flag.flagtype === 'low_suspicion') {\n        iconName = 'i/flagged';\n        cssClass = 'agentdetect-badge text-warning';\n        tooltip = 'Low suspicion (score: ' + flag.maxscore + ')';\n    } else if (flag.flagtype === 'likely_human') {\n        iconName = 'i/checkedcircle';\n        cssClass = 'agentdetect-badge text-success';\n        tooltip = 'Likely human (score: ' + flag.maxscore + ')';\n    } else {\n        // Cleared or unknown â€” don't show badge.\n        return;\n    }\n\n    // Build the badge link to the course report.\n    const reportUrl = config.reportUrl + '&userid=' + flag.userid;\n\n    const badgeLink = document.createElement('a');\n    badgeLink.href = reportUrl;\n    badgeLink.className = cssClass;\n    badgeLink.title = tooltip;\n    badgeLink.style.marginLeft = '4px';\n    badgeLink.style.textDecoration = 'none';\n\n    // Use Moodle pix icon.\n    const img = document.createElement('img');\n    img.src = M.util.image_url(iconName, 'core');\n    img.alt = tooltip;\n    img.className = 'icon';\n    img.style.width = '16px';\n    img.style.height = '16px';\n\n    badgeLink.appendChild(img);\n    link.parentElement.insertBefore(badgeLink, link.nextSibling);\n};\n"],"names":["config","debug","mode","injectOverviewBadges","injectReviewBadge","async","userLinks","document","querySelectorAll","length","userMap","Map","forEach","link","url","URL","href","window","location","origin","uid","parseInt","searchParams","get","isNaN","has","set","push","size","userIds","Array","from","keys","fetchFlags","contextid","flag","links","userid","appendBadge","err","error","summaryTable","querySelector","userLink","flags","contextId","Ajax","call","methodname","args","userids","parentElement","iconName","cssClass","tooltip","flagtype","replace","maxscore","reportUrl","badgeLink","createElement","className","title","style","marginLeft","textDecoration","img","src","M","util","image_url","alt","width","height","appendChild","insertBefore","nextSibling"],"mappings":";;;;;;;;;;sKAsCqBA,sBACbC,MAAM,gDAAiDD,QAEvC,aAAhBA,OAAOE,KACPC,qBAAqBH,QACE,WAAhBA,OAAOE,MACdE,kBAAkBJ,eAYpBG,qBAAuBE,MAAAA,eAEnBC,UAAYC,SAASC,iBACvB,sGAICF,UAAUG,gCACPR,MAAM,mEAKRS,QAAU,IAAIC,OACpBL,UAAUM,SAASC,aACTC,IAAM,IAAIC,IAAIF,KAAKG,KAAMC,OAAOC,SAASC,QACzCC,IAAMC,SAASP,IAAIQ,aAAaC,IAAI,MAAO,IAC7CH,MAAQI,MAAMJ,OACTV,QAAQe,IAAIL,MACbV,QAAQgB,IAAIN,IAAK,IAErBV,QAAQa,IAAIH,KAAKO,KAAKd,WAIzBH,QAAQkB,kBAIPC,QAAUC,MAAMC,KAAKrB,QAAQsB,qBAC/B/B,MAAM,yCAA0C4B,QAAQpB,OAAQ,oBAG5CwB,WAAWJ,QAAS7B,OAAOkC,YACzCtB,SAASuB,aACLC,MAAQ1B,QAAQa,IAAIY,KAAKE,QAC3BD,OAASA,MAAM3B,OAAS,GAExB6B,YAAYF,MAAM,GAAID,KAAMnC,WAGtC,MAAOuC,kBACDC,MAAM,6CAA8CD,OAY1DnC,kBAAoBC,MAAAA,eAEhBoC,aAAelC,SAASmC,cAAc,+BACvCD,sCACGxC,MAAM,iEAIR0C,SAAWF,aAAaC,cAAc,gCACvCC,sBAIC7B,IAAM,IAAIC,IAAI4B,SAAS3B,KAAMC,OAAOC,SAASC,QAC7CC,IAAMC,SAASP,IAAIQ,aAAaC,IAAI,MAAO,OAC5CH,MAAOI,MAAMJ,eAKRwB,YAAcX,WAAW,CAACb,KAAMpB,OAAOkC,WACzCU,MAAMnC,OAAS,GACf6B,YAAYK,SAAUC,MAAM,GAAI5C,QAEtC,MAAOuC,kBACDC,MAAM,4CAA6CD,OAWzDN,WAAa,CAACJ,QAASgB,YACTC,cAAKC,KAAK,CAAC,CACvBC,WAAY,mCACZC,KAAM,CACFC,QAASrB,QACTK,UAAWW,cAGJ,GAUbP,YAAc,CAACzB,KAAMsB,KAAMnC,aAEzBa,KAAKsC,cAAcT,cAAc,iCAIjCU,SACAC,SACAC,WAEkB,oBAAlBnB,KAAKoB,UAAoD,oBAAlBpB,KAAKoB,SAC5CH,SAAW,YACXC,SAAW,gCACXC,QAAUnB,KAAKoB,SAASC,QAAQ,IAAK,KAAO,YAAcrB,KAAKsB,SAAW,SACvE,GAAsB,kBAAlBtB,KAAKoB,SACZH,SAAW,YACXC,SAAW,iCACXC,QAAU,yBAA2BnB,KAAKsB,SAAW,QAClD,CAAA,GAAsB,iBAAlBtB,KAAKoB,gBACZH,SAAW,kBACXC,SAAW,iCACXC,QAAU,wBAA0BnB,KAAKsB,SAAW,UAOlDC,UAAY1D,OAAO0D,UAAY,WAAavB,KAAKE,OAEjDsB,UAAYpD,SAASqD,cAAc,KACzCD,UAAU3C,KAAO0C,UACjBC,UAAUE,UAAYR,SACtBM,UAAUG,MAAQR,QAClBK,UAAUI,MAAMC,WAAa,MAC7BL,UAAUI,MAAME,eAAiB,aAG3BC,IAAM3D,SAASqD,cAAc,OACnCM,IAAIC,IAAMC,EAAEC,KAAKC,UAAUlB,SAAU,QACrCc,IAAIK,IAAMjB,QACVY,IAAIL,UAAY,OAChBK,IAAIH,MAAMS,MAAQ,OAClBN,IAAIH,MAAMU,OAAS,OAEnBd,UAAUe,YAAYR,KACtBrD,KAAKsC,cAAcwB,aAAahB,UAAW9C,KAAK+D"}