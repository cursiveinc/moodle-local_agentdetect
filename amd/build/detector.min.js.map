{"version":3,"file":"detector.min.js","sources":["../src/detector.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Main agent detection module.\n *\n * Orchestrates fingerprint and interaction detection, combines results,\n * and reports to the Moodle backend.\n *\n * @module     local_agentdetect/detector\n * @copyright  2024 Your Institution\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Fingerprint from 'local_agentdetect/fingerprint';\nimport * as Interaction from 'local_agentdetect/interaction';\nimport * as Injection from 'local_agentdetect/injection';\nimport Ajax from 'core/ajax';\nimport Log from 'core/log';\n\n/**\n * Configuration passed from PHP.\n *\n * @type {Object}\n */\nlet config = {\n    enabled: true,\n    reportInterval: 30000, // ms - how often to report to server.\n    minReportScore: 10, // Minimum combined score to report.\n    contextId: null,\n    sessionKey: null,\n    debug: false,\n};\n\n/**\n * Report timer reference.\n *\n * @type {number|null}\n */\nlet reportTimer = null;\n\n/**\n * Session ID for this detection session.\n *\n * @type {string}\n */\nlet sessionId = null;\n\n/**\n * Whether detection has been initialized.\n *\n * @type {boolean}\n */\nlet initialized = false;\n\n/**\n * Initialize the agent detection system.\n *\n * @param {Object} options Configuration options from PHP.\n * @returns {Promise<void>}\n */\nexport const init = async(options = {}) => {\n    if (initialized) {\n        Log.debug('[AgentDetect] Already initialized');\n        return;\n    }\n\n    // Merge config.\n    config = {...config, ...options};\n\n    if (!config.enabled) {\n        Log.debug('[AgentDetect] Detection disabled');\n        return;\n    }\n\n    // Generate session ID.\n    sessionId = generateSessionId();\n\n    Log.debug('[AgentDetect] Initializing detection', {sessionId, config});\n\n    // Start interaction monitoring.\n    Interaction.startMonitoring();\n\n    // Start injection detection (watches for AI helper UI injected by extensions).\n    Injection.startMonitoring({debug: config.debug});\n\n    // Collect initial fingerprint.\n    const initialFingerprint = await Fingerprint.collect();\n\n    if (config.debug) {\n        Log.debug('[AgentDetect] Initial fingerprint:', initialFingerprint);\n    }\n\n    // If fingerprint score is high, report immediately.\n    if (initialFingerprint.score >= config.minReportScore) {\n        await reportSignals({\n            type: 'fingerprint',\n            data: initialFingerprint,\n        });\n    }\n\n    // Start periodic reporting.\n    startPeriodicReporting();\n\n    // Report on page unload.\n    window.addEventListener('beforeunload', handlePageUnload);\n\n    // Report on visibility change (tab switching).\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n\n    initialized = true;\n    Log.debug('[AgentDetect] Initialization complete');\n};\n\n/**\n * Generate a unique session ID.\n *\n * @returns {string} Session ID.\n */\nconst generateSessionId = () => {\n    const timestamp = Date.now().toString(36);\n    const random = Math.random().toString(36).substring(2, 10);\n    return `${timestamp}-${random}`;\n};\n\n/**\n * Start periodic reporting to the server.\n *\n * @returns {void}\n */\nconst startPeriodicReporting = () => {\n    if (reportTimer) {\n        clearInterval(reportTimer);\n    }\n\n    reportTimer = setInterval(async() => {\n        await collectAndReport();\n    }, config.reportInterval);\n};\n\n/**\n * Stop periodic reporting.\n *\n * @returns {void}\n */\nconst stopPeriodicReporting = () => {\n    if (reportTimer) {\n        clearInterval(reportTimer);\n        reportTimer = null;\n    }\n};\n\n/**\n * Collect all signals and report to server.\n *\n * @returns {Promise<Object>} Combined analysis results.\n */\nexport const collectAndReport = async() => {\n    // Collect fingerprint.\n    const fingerprint = await Fingerprint.collect();\n\n    // Analyze interactions.\n    const interaction = Interaction.analyze();\n\n    // Analyze injected content (AI helper extensions).\n    const injection = Injection.analyze();\n\n    // Combine scores.\n    const combinedScore = calculateCombinedScore(fingerprint.score, interaction.score, injection.score);\n\n    const result = {\n        sessionId,\n        timestamp: Date.now(),\n        pageUrl: window.location.href,\n        pageTitle: document.title,\n        fingerprint,\n        interaction,\n        injection,\n        combinedScore,\n        verdict: getVerdict(combinedScore),\n    };\n\n    if (config.debug) {\n        Log.debug('[AgentDetect] Analysis result:', result);\n    }\n\n    // Only report if score meets threshold.\n    if (combinedScore >= config.minReportScore) {\n        await reportSignals({\n            type: 'combined',\n            data: result,\n        });\n    }\n\n    return result;\n};\n\n/**\n * Calculate combined score from fingerprint, interaction, and injection signals.\n *\n * Interaction score is the primary signal (catches human-driven AI tool usage).\n * Injection score adds evidence of AI helper extensions being present.\n * Fingerprint score is a bonus when detected (catches automated headless browsers).\n *\n * @param {number} fingerprintScore Fingerprint score (0-100).\n * @param {number} interactionScore Interaction score (0-100).\n * @param {number} injectionScore Injection detection score (0-100).\n * @returns {number} Combined score (0-100).\n */\nconst calculateCombinedScore = (fingerprintScore, interactionScore, injectionScore = 0) => {\n    // Interaction is the base score - it catches both:\n    // 1. Automated agents (teleport clicks, superhuman speed)\n    // 2. Human-driven AI usage (tab switches, copy-paste patterns, pauses)\n    let score = interactionScore;\n\n    // Injection detection adds to the score - catches AI helper extensions.\n    // This is direct evidence of tools being present on the page.\n    if (injectionScore >= 50) {\n        // Strong injection signals - significant boost.\n        score = Math.min(100, score + 25);\n    } else if (injectionScore >= 25) {\n        // Moderate injection signals - modest boost.\n        score = Math.min(100, score + 15);\n    } else if (injectionScore >= 10) {\n        // Weak injection signals - small boost.\n        score = Math.min(100, score + 5);\n    }\n\n    // Fingerprint is a bonus - only helps when it detects something.\n    // This catches headless browsers, automation tools with webdriver flag, etc.\n    // Modern extension-based AI tools won't trigger fingerprint, and that's OK.\n    if (fingerprintScore >= 70) {\n        // Strong automation fingerprint - significant boost.\n        score = Math.min(100, score + 30);\n    } else if (fingerprintScore >= 40) {\n        // Moderate fingerprint signals - modest boost.\n        score = Math.min(100, score + 15);\n    } else if (fingerprintScore >= 20) {\n        // Weak fingerprint signals - small boost.\n        score = Math.min(100, score + 5);\n    }\n    // If fingerprint is 0-19, no adjustment - interaction score stands alone.\n\n    return Math.round(score);\n};\n\n/**\n * Get human-readable verdict from score.\n *\n * @param {number} score Combined score.\n * @returns {string} Verdict string.\n */\nconst getVerdict = (score) => {\n    if (score >= 80) {\n        return 'HIGH_CONFIDENCE_AGENT';\n    } else if (score >= 60) {\n        return 'PROBABLE_AGENT';\n    } else if (score >= 40) {\n        return 'SUSPICIOUS';\n    } else if (score >= 20) {\n        return 'LOW_SUSPICION';\n    }\n    return 'LIKELY_HUMAN';\n};\n\n/**\n * Report signals to the Moodle backend.\n *\n * @param {Object} payload Signal data to report.\n * @returns {Promise<void>}\n */\nconst reportSignals = async(payload) => {\n    if (!config.sessionKey) {\n        Log.warn('[AgentDetect] No session key configured, skipping report');\n        return;\n    }\n\n    try {\n        const response = await Ajax.call([{\n            methodname: 'local_agentdetect_report_signals',\n            args: {\n                sesskey: config.sessionKey,\n                contextid: config.contextId,\n                sessionid: sessionId,\n                signaltype: payload.type,\n                signaldata: JSON.stringify(payload.data),\n            },\n        }])[0];\n\n        if (config.debug) {\n            Log.debug('[AgentDetect] Report response:', response);\n        }\n    } catch (error) {\n        Log.error('[AgentDetect] Failed to report signals:', error);\n    }\n};\n\n/**\n * Handle page unload - send final report.\n *\n * @returns {void}\n */\nconst handlePageUnload = () => {\n    // Use sendBeacon for reliable delivery during unload.\n    if (navigator.sendBeacon && config.sessionKey) {\n        const interaction = Interaction.analyze();\n        const payload = {\n            sesskey: config.sessionKey,\n            contextid: config.contextId,\n            sessionid: sessionId,\n            signaltype: 'unload',\n            signaldata: JSON.stringify({\n                pageUrl: window.location.href,\n                pageTitle: document.title,\n                interaction,\n                duration: Date.now() - (Interaction.getRawData().startTime || Date.now()),\n            }),\n        };\n\n        const url = M.cfg.wwwroot + '/local/agentdetect/beacon.php';\n        navigator.sendBeacon(url, JSON.stringify(payload));\n    }\n};\n\n/**\n * Handle visibility change - report when tab loses focus.\n *\n * @returns {void}\n */\nconst handleVisibilityChange = async() => {\n    if (document.visibilityState === 'hidden') {\n        // Tab lost focus - good time to report.\n        await collectAndReport();\n    }\n};\n\n/**\n * Manually trigger detection analysis.\n *\n * Useful for testing or on-demand checks.\n *\n * @returns {Promise<Object>} Analysis results.\n */\nexport const runAnalysis = async() => {\n    return await collectAndReport();\n};\n\n/**\n * Get current detection status.\n *\n * @returns {Object} Status information.\n */\nexport const getStatus = () => {\n    return {\n        initialized,\n        sessionId,\n        isMonitoring: Interaction.getRawData().isMonitoring,\n        config: {\n            enabled: config.enabled,\n            reportInterval: config.reportInterval,\n            minReportScore: config.minReportScore,\n        },\n    };\n};\n\n/**\n * Shutdown detection and cleanup.\n *\n * @returns {void}\n */\nexport const shutdown = () => {\n    stopPeriodicReporting();\n    Interaction.stopMonitoring();\n    Injection.stopMonitoring();\n    window.removeEventListener('beforeunload', handlePageUnload);\n    document.removeEventListener('visibilitychange', handleVisibilityChange);\n    initialized = false;\n    Log.debug('[AgentDetect] Shutdown complete');\n};\n\nexport default {\n    init,\n    runAnalysis,\n    getStatus,\n    shutdown,\n    collectAndReport,\n};\n"],"names":["config","enabled","reportInterval","minReportScore","contextId","sessionKey","debug","reportTimer","sessionId","initialized","init","async","options","generateSessionId","Interaction","startMonitoring","Injection","initialFingerprint","Fingerprint","collect","score","reportSignals","type","data","startPeriodicReporting","window","addEventListener","handlePageUnload","document","handleVisibilityChange","Date","now","toString","Math","random","substring","clearInterval","setInterval","collectAndReport","fingerprint","interaction","analyze","injection","combinedScore","calculateCombinedScore","result","timestamp","pageUrl","location","href","pageTitle","title","verdict","getVerdict","fingerprintScore","interactionScore","injectionScore","min","round","response","Ajax","call","methodname","args","sesskey","contextid","sessionid","signaltype","payload","signaldata","JSON","stringify","error","warn","navigator","sendBeacon","duration","getRawData","startTime","url","M","cfg","wwwroot","visibilityState","runAnalysis","getStatus","isMonitoring","shutdown","stopMonitoring","removeEventListener"],"mappings":"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"}