{"version":3,"file":"interaction.min.js","sources":["../src/interaction.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Interaction anomaly detection module.\n *\n * Monitors user interactions (mouse, keyboard, scroll) to detect\n * patterns typical of automated browsers versus human users.\n *\n * @module     local_agentdetect/interaction\n * @copyright  2024 Your Institution\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n/**\n * Configuration for interaction monitoring.\n *\n * @type {Object}\n */\nconst CONFIG = {\n    // Minimum data points before analysis.\n    minMouseMoves: 20,\n    minClicks: 3,\n    minKeystrokes: 10,\n\n    // Thresholds for anomaly detection.\n    perfectTimingVariance: 5, // ms - variance below this is suspicious.\n    minHumanReactionTime: 50, // ms - clicks faster than this are suspicious.\n    maxMouseSpeed: 10000, // px/ms - movements faster than this are suspicious.\n    centerClickTolerance: 5, // px - clicks within this of element center are suspicious.\n\n    // Sampling configuration.\n    maxStoredEvents: 500,\n    analysisInterval: 10000, // ms - how often to run analysis.\n};\n\n/**\n * Event storage for analysis.\n *\n * @type {Object}\n */\nconst eventStore = {\n    mouseMoves: [],\n    clicks: [],\n    keystrokes: [],\n    scrolls: [],\n    hovers: [],\n    focusChanges: [],\n    startTime: Date.now(),\n};\n\n/**\n * Analysis results cache.\n *\n * @type {Object|null}\n */\nlet analysisCache = null;\n\n/**\n * Whether monitoring is active.\n *\n * @type {boolean}\n */\nlet isMonitoring = false;\n\n/**\n * Start monitoring user interactions.\n *\n * @returns {void}\n */\nexport const startMonitoring = () => {\n    if (isMonitoring) {\n        return;\n    }\n\n    isMonitoring = true;\n    eventStore.startTime = Date.now();\n\n    // Mouse movement tracking.\n    document.addEventListener('mousemove', handleMouseMove, {passive: true});\n\n    // Click tracking (capture phase to get all clicks).\n    document.addEventListener('click', handleClick, {capture: true, passive: true});\n    document.addEventListener('mousedown', handleMouseDown, {capture: true, passive: true});\n    document.addEventListener('mouseup', handleMouseUp, {capture: true, passive: true});\n\n    // Hover tracking.\n    document.addEventListener('mouseover', handleMouseOver, {passive: true});\n    document.addEventListener('mouseout', handleMouseOut, {passive: true});\n\n    // Keyboard tracking.\n    document.addEventListener('keydown', handleKeyDown, {capture: true, passive: true});\n    document.addEventListener('keyup', handleKeyUp, {capture: true, passive: true});\n\n    // Scroll tracking.\n    document.addEventListener('scroll', handleScroll, {passive: true});\n    window.addEventListener('scroll', handleScroll, {passive: true});\n\n    // Focus tracking.\n    document.addEventListener('focusin', handleFocusIn, {passive: true});\n    document.addEventListener('focusout', handleFocusOut, {passive: true});\n};\n\n/**\n * Stop monitoring user interactions.\n *\n * @returns {void}\n */\nexport const stopMonitoring = () => {\n    if (!isMonitoring) {\n        return;\n    }\n\n    isMonitoring = false;\n\n    document.removeEventListener('mousemove', handleMouseMove);\n    document.removeEventListener('click', handleClick, {capture: true});\n    document.removeEventListener('mousedown', handleMouseDown, {capture: true});\n    document.removeEventListener('mouseup', handleMouseUp, {capture: true});\n    document.removeEventListener('mouseover', handleMouseOver);\n    document.removeEventListener('mouseout', handleMouseOut);\n    document.removeEventListener('keydown', handleKeyDown, {capture: true});\n    document.removeEventListener('keyup', handleKeyUp, {capture: true});\n    document.removeEventListener('scroll', handleScroll);\n    window.removeEventListener('scroll', handleScroll);\n    document.removeEventListener('focusin', handleFocusIn);\n    document.removeEventListener('focusout', handleFocusOut);\n};\n\n/**\n * Handle mouse move events.\n *\n * @param {MouseEvent} e Mouse event.\n */\nconst handleMouseMove = (e) => {\n    const now = performance.now();\n    const lastMove = eventStore.mouseMoves[eventStore.mouseMoves.length - 1];\n\n    const moveData = {\n        x: e.clientX,\n        y: e.clientY,\n        timestamp: now,\n        deltaTime: lastMove ? now - lastMove.timestamp : 0,\n        deltaX: lastMove ? e.clientX - lastMove.x : 0,\n        deltaY: lastMove ? e.clientY - lastMove.y : 0,\n    };\n\n    // Calculate velocity.\n    if (moveData.deltaTime > 0) {\n        const distance = Math.sqrt(moveData.deltaX ** 2 + moveData.deltaY ** 2);\n        moveData.velocity = distance / moveData.deltaTime;\n    }\n\n    addToStore('mouseMoves', moveData);\n};\n\n/**\n * Handle click events.\n *\n * @param {MouseEvent} e Mouse event.\n */\nconst handleClick = (e) => {\n    const now = performance.now();\n    const target = e.target;\n    const rect = target.getBoundingClientRect();\n\n    // Calculate click position relative to element center.\n    const elementCenterX = rect.left + rect.width / 2;\n    const elementCenterY = rect.top + rect.height / 2;\n    const offsetFromCenter = Math.sqrt(\n        (e.clientX - elementCenterX) ** 2 +\n        (e.clientY - elementCenterY) ** 2\n    );\n\n    const clickData = {\n        x: e.clientX,\n        y: e.clientY,\n        timestamp: now,\n        target: {\n            tagName: target.tagName,\n            id: target.id,\n            className: target.className,\n            width: rect.width,\n            height: rect.height,\n        },\n        offsetFromCenter: offsetFromCenter,\n        hadPrecedingHover: checkPrecedingHover(target),\n        hadPrecedingMouseMove: checkPrecedingMouseMove(e.clientX, e.clientY),\n    };\n\n    addToStore('clicks', clickData);\n};\n\n/**\n * Handle mousedown events.\n */\nconst handleMouseDown = () => {\n    // Store for click duration analysis.\n    const lastClick = eventStore.clicks[eventStore.clicks.length - 1];\n    if (lastClick && !lastClick.mousedownTime) {\n        lastClick.mousedownTime = performance.now();\n    }\n};\n\n/**\n * Handle mouseup events.\n */\nconst handleMouseUp = () => {\n    // Calculate click duration.\n    const lastClick = eventStore.clicks[eventStore.clicks.length - 1];\n    if (lastClick && lastClick.mousedownTime) {\n        lastClick.clickDuration = performance.now() - lastClick.mousedownTime;\n    }\n};\n\n/**\n * Handle mouseover events.\n *\n * @param {MouseEvent} e Mouse event.\n */\nconst handleMouseOver = (e) => {\n    addToStore('hovers', {\n        target: e.target,\n        timestamp: performance.now(),\n        type: 'over',\n    });\n};\n\n/**\n * Handle mouseout events.\n *\n * @param {MouseEvent} e Mouse event.\n */\nconst handleMouseOut = (e) => {\n    addToStore('hovers', {\n        target: e.target,\n        timestamp: performance.now(),\n        type: 'out',\n    });\n};\n\n/**\n * Handle keydown events.\n *\n * @param {KeyboardEvent} e Keyboard event.\n */\nconst handleKeyDown = (e) => {\n    const now = performance.now();\n    const lastKeystroke = eventStore.keystrokes[eventStore.keystrokes.length - 1];\n\n    addToStore('keystrokes', {\n        key: e.key.length === 1 ? 'char' : e.key, // Don't store actual characters for privacy.\n        timestamp: now,\n        deltaTime: lastKeystroke ? now - lastKeystroke.timestamp : 0,\n        type: 'down',\n    });\n};\n\n/**\n * Handle keyup events.\n */\nconst handleKeyUp = () => {\n    // Find matching keydown to calculate hold duration.\n    const keydowns = eventStore.keystrokes.filter(\n        (k) => k.type === 'down' && !k.holdDuration\n    );\n    const matchingKeydown = keydowns[keydowns.length - 1];\n    if (matchingKeydown) {\n        matchingKeydown.holdDuration = performance.now() - matchingKeydown.timestamp;\n    }\n};\n\n/**\n * Handle scroll events.\n */\nconst handleScroll = () => {\n    const now = performance.now();\n    const lastScroll = eventStore.scrolls[eventStore.scrolls.length - 1];\n\n    addToStore('scrolls', {\n        scrollY: window.scrollY,\n        scrollX: window.scrollX,\n        timestamp: now,\n        deltaTime: lastScroll ? now - lastScroll.timestamp : 0,\n        deltaY: lastScroll ? window.scrollY - lastScroll.scrollY : 0,\n        deltaX: lastScroll ? window.scrollX - lastScroll.scrollX : 0,\n    });\n};\n\n/**\n * Handle focus in events.\n *\n * @param {FocusEvent} e Focus event.\n */\nconst handleFocusIn = (e) => {\n    addToStore('focusChanges', {\n        target: {\n            tagName: e.target.tagName,\n            id: e.target.id,\n            type: e.target.type,\n        },\n        timestamp: performance.now(),\n        type: 'in',\n    });\n};\n\n/**\n * Handle focus out events.\n *\n * @param {FocusEvent} e Focus event.\n */\nconst handleFocusOut = (e) => {\n    addToStore('focusChanges', {\n        target: {\n            tagName: e.target.tagName,\n            id: e.target.id,\n            type: e.target.type,\n        },\n        timestamp: performance.now(),\n        type: 'out',\n    });\n};\n\n/**\n * Add event to storage with size limiting.\n *\n * @param {string} storeName Name of the store.\n * @param {Object} data Event data.\n */\nconst addToStore = (storeName, data) => {\n    eventStore[storeName].push(data);\n\n    // Limit store size.\n    if (eventStore[storeName].length > CONFIG.maxStoredEvents) {\n        eventStore[storeName].shift();\n    }\n\n    // Invalidate cache.\n    analysisCache = null;\n};\n\n/**\n * Check if there was a hover event before this click.\n *\n * @param {Element} target Click target.\n * @returns {boolean} True if hover preceded click.\n */\nconst checkPrecedingHover = (target) => {\n    const recentHovers = eventStore.hovers.slice(-20);\n    return recentHovers.some((h) => h.target === target && h.type === 'over');\n};\n\n/**\n * Check if there was mouse movement leading to click position.\n *\n * @param {number} x Click X coordinate.\n * @param {number} y Click Y coordinate.\n * @returns {boolean} True if mouse movement preceded click.\n */\nconst checkPrecedingMouseMove = (x, y) => {\n    const recentMoves = eventStore.mouseMoves.slice(-10);\n    if (recentMoves.length === 0) {\n        return false;\n    }\n\n    // Check if any recent movement was near the click position.\n    return recentMoves.some((m) => {\n        const distance = Math.sqrt((m.x - x) ** 2 + (m.y - y) ** 2);\n        return distance < 50;\n    });\n};\n\n/**\n * Analyze collected interaction data for anomalies.\n *\n * @returns {Object} Analysis results with anomaly signals.\n */\nexport const analyze = () => {\n    if (analysisCache) {\n        return analysisCache;\n    }\n\n    const results = {\n        timestamp: Date.now(),\n        duration: Date.now() - eventStore.startTime,\n        eventCounts: {\n            mouseMoves: eventStore.mouseMoves.length,\n            clicks: eventStore.clicks.length,\n            keystrokes: eventStore.keystrokes.length,\n            scrolls: eventStore.scrolls.length,\n            hovers: eventStore.hovers.length,\n            focusChanges: eventStore.focusChanges.length,\n        },\n        anomalies: [],\n        score: 0,\n    };\n\n    // Run individual analyses.\n    results.anomalies.push(...analyzeMouseMovement());\n    results.anomalies.push(...analyzeClicks());\n    results.anomalies.push(...analyzeKeystrokes());\n    results.anomalies.push(...analyzeScrolling());\n    results.anomalies.push(...analyzeEventSequence());\n\n    // Calculate overall score.\n    results.score = calculateInteractionScore(results.anomalies);\n\n    analysisCache = results;\n    return results;\n};\n\n/**\n * Analyze mouse movement patterns.\n *\n * @returns {Array} Anomaly signals.\n */\nconst analyzeMouseMovement = () => {\n    const anomalies = [];\n    const moves = eventStore.mouseMoves;\n\n    if (moves.length < CONFIG.minMouseMoves) {\n        anomalies.push({\n            name: 'mouse.insufficient_data',\n            value: moves.length,\n            weight: 2,\n        });\n        return anomalies;\n    }\n\n    // Check for perfectly linear movements (no human does this).\n    const linearSegments = findLinearSegments(moves);\n    if (linearSegments > moves.length * 0.3) {\n        anomalies.push({\n            name: 'mouse.linear_movement',\n            value: linearSegments / moves.length,\n            weight: 7,\n        });\n    }\n\n    // Check for teleporting (instant position changes).\n    const teleports = moves.filter((m) => m.velocity > CONFIG.maxMouseSpeed);\n    if (teleports.length > 0) {\n        anomalies.push({\n            name: 'mouse.teleport',\n            value: teleports.length,\n            weight: 8,\n        });\n    }\n\n    // Check for no mouse movement at all (common in automated tests).\n    const duration = Date.now() - eventStore.startTime;\n    if (moves.length < duration / 5000) { // Less than 1 move per 5 seconds.\n        anomalies.push({\n            name: 'mouse.sparse_movement',\n            value: moves.length,\n            weight: 5,\n        });\n    }\n\n    // Check velocity variance (humans have high variance).\n    const velocities = moves.filter((m) => m.velocity).map((m) => m.velocity);\n    if (velocities.length > 5) {\n        const variance = calculateVariance(velocities);\n        if (variance < 0.1) {\n            anomalies.push({\n                name: 'mouse.constant_velocity',\n                value: variance,\n                weight: 6,\n            });\n        }\n    }\n\n    return anomalies;\n};\n\n/**\n * Find linear segments in mouse movement.\n *\n * @param {Array} moves Mouse move events.\n * @returns {number} Count of linear segments.\n */\nconst findLinearSegments = (moves) => {\n    let linearCount = 0;\n    const threshold = 0.99; // Angle consistency threshold.\n\n    for (let i = 2; i < moves.length; i++) {\n        const angle1 = Math.atan2(\n            moves[i - 1].y - moves[i - 2].y,\n            moves[i - 1].x - moves[i - 2].x\n        );\n        const angle2 = Math.atan2(\n            moves[i].y - moves[i - 1].y,\n            moves[i].x - moves[i - 1].x\n        );\n\n        if (Math.abs(Math.cos(angle1 - angle2)) > threshold) {\n            linearCount++;\n        }\n    }\n\n    return linearCount;\n};\n\n/**\n * Analyze click patterns.\n *\n * @returns {Array} Anomaly signals.\n */\nconst analyzeClicks = () => {\n    const anomalies = [];\n    const clicks = eventStore.clicks;\n\n    if (clicks.length < CONFIG.minClicks) {\n        return anomalies;\n    }\n\n    // Check for clicks at exact element centers (agents click perfectly).\n    const centerClicks = clicks.filter(\n        (c) => c.offsetFromCenter < CONFIG.centerClickTolerance\n    );\n    if (centerClicks.length > clicks.length * 0.5) {\n        anomalies.push({\n            name: 'click.center_precision',\n            value: centerClicks.length / clicks.length,\n            weight: 10, // Increased - strong agent indicator.\n        });\n    }\n\n    // Check for clicks without preceding hover.\n    const noHoverClicks = clicks.filter((c) => !c.hadPrecedingHover);\n    if (noHoverClicks.length > clicks.length * 0.7) {\n        anomalies.push({\n            name: 'click.no_hover',\n            value: noHoverClicks.length / clicks.length,\n            weight: 6,\n        });\n    }\n\n    // Check for clicks without preceding mouse movement (teleport clicks).\n    const noMoveClicks = clicks.filter((c) => !c.hadPrecedingMouseMove);\n    if (noMoveClicks.length > clicks.length * 0.5) {\n        anomalies.push({\n            name: 'click.no_movement',\n            value: noMoveClicks.length / clicks.length,\n            weight: 9, // Increased - agents teleport to click targets.\n        });\n    }\n\n    // STRONG INDICATOR: Clicks with NO mouse data at all (pure teleport).\n    const totalMouseMoves = eventStore.mouseMoves.length;\n    if (clicks.length >= 3 && totalMouseMoves < clicks.length * 2) {\n        anomalies.push({\n            name: 'click.teleport_pattern',\n            value: totalMouseMoves / clicks.length,\n            weight: 10, // Very strong - humans move mouse much more than they click.\n        });\n    }\n\n    // Check for impossibly fast clicks (< 50ms reaction time).\n    const interClickTimes = [];\n    for (let i = 1; i < clicks.length; i++) {\n        interClickTimes.push(clicks[i].timestamp - clicks[i - 1].timestamp);\n    }\n    const fastClicks = interClickTimes.filter((t) => t < CONFIG.minHumanReactionTime);\n    if (fastClicks.length > 0) {\n        anomalies.push({\n            name: 'click.superhuman_speed',\n            value: fastClicks.length,\n            weight: 10, // Increased - definitive agent indicator.\n        });\n    }\n\n    // Check for perfectly regular click timing.\n    if (interClickTimes.length >= 3) {\n        const variance = calculateVariance(interClickTimes);\n        if (variance < CONFIG.perfectTimingVariance) {\n            anomalies.push({\n                name: 'click.perfect_timing',\n                value: variance,\n                weight: 8,\n            });\n        }\n    }\n\n    return anomalies;\n};\n\n/**\n * Analyze keystroke patterns.\n *\n * @returns {Array} Anomaly signals.\n */\nconst analyzeKeystrokes = () => {\n    const anomalies = [];\n    const keystrokes = eventStore.keystrokes.filter((k) => k.type === 'down');\n\n    if (keystrokes.length < CONFIG.minKeystrokes) {\n        return anomalies;\n    }\n\n    // Check inter-key timing variance.\n    const interKeyTimes = keystrokes.slice(1).map((k) => k.deltaTime);\n    if (interKeyTimes.length >= 5) {\n        const variance = calculateVariance(interKeyTimes);\n        if (variance < CONFIG.perfectTimingVariance) {\n            anomalies.push({\n                name: 'keystroke.perfect_timing',\n                value: variance,\n                weight: 9,\n            });\n        }\n    }\n\n    // Check for impossibly fast typing (< 30ms between keys is ~2000 WPM).\n    const fastKeys = interKeyTimes.filter((t) => t > 0 && t < 30);\n    if (fastKeys.length > interKeyTimes.length * 0.3) {\n        anomalies.push({\n            name: 'keystroke.superhuman_speed',\n            value: fastKeys.length / interKeyTimes.length,\n            weight: 9,\n        });\n    }\n\n    // Check key hold duration variance.\n    const holdDurations = keystrokes.filter((k) => k.holdDuration).map((k) => k.holdDuration);\n    if (holdDurations.length >= 5) {\n        const variance = calculateVariance(holdDurations);\n        if (variance < 1) {\n            anomalies.push({\n                name: 'keystroke.constant_hold',\n                value: variance,\n                weight: 7,\n            });\n        }\n    }\n\n    return anomalies;\n};\n\n/**\n * Analyze scrolling patterns.\n *\n * @returns {Array} Anomaly signals.\n */\nconst analyzeScrolling = () => {\n    const anomalies = [];\n    const scrolls = eventStore.scrolls;\n\n    if (scrolls.length < 3) {\n        return anomalies;\n    }\n\n    // Check for instant scroll jumps (no smooth scrolling).\n    const instantScrolls = scrolls.filter((s) => s.deltaTime < 10 && Math.abs(s.deltaY) > 100);\n    if (instantScrolls.length > scrolls.length * 0.5) {\n        anomalies.push({\n            name: 'scroll.instant_jump',\n            value: instantScrolls.length / scrolls.length,\n            weight: 6,\n        });\n    }\n\n    // Check for perfectly regular scroll amounts.\n    const scrollAmounts = scrolls.map((s) => Math.abs(s.deltaY)).filter((v) => v > 0);\n    if (scrollAmounts.length >= 3) {\n        const variance = calculateVariance(scrollAmounts);\n        if (variance < 1) {\n            anomalies.push({\n                name: 'scroll.constant_amount',\n                value: variance,\n                weight: 5,\n            });\n        }\n    }\n\n    return anomalies;\n};\n\n/**\n * Analyze event sequence patterns.\n *\n * @returns {Array} Anomaly signals.\n */\nconst analyzeEventSequence = () => {\n    const anomalies = [];\n\n    // Check for missing event sequences (e.g., click without mousedown).\n    // Automated tools sometimes skip intermediate events.\n\n    // Check ratio of hovers to clicks (humans hover a lot before clicking).\n    const hoverRatio = eventStore.hovers.length / Math.max(eventStore.clicks.length, 1);\n    if (hoverRatio < 2 && eventStore.clicks.length >= CONFIG.minClicks) {\n        anomalies.push({\n            name: 'sequence.low_hover_ratio',\n            value: hoverRatio,\n            weight: 5,\n        });\n    }\n\n    // Check for focus changes without preceding clicks or tabs.\n    // Direct focus (via JS) is common in automation.\n    const directFocus = eventStore.focusChanges.filter((f) => {\n        // Check if there was a recent click or keystroke.\n        const recentEvents = [\n            ...eventStore.clicks.slice(-5),\n            ...eventStore.keystrokes.slice(-5),\n        ];\n        const hasRecentInteraction = recentEvents.some(\n            (e) => Math.abs(e.timestamp - f.timestamp) < 100\n        );\n        return !hasRecentInteraction;\n    });\n\n    if (directFocus.length > eventStore.focusChanges.length * 0.5 &&\n        eventStore.focusChanges.length >= 3) {\n        anomalies.push({\n            name: 'sequence.direct_focus',\n            value: directFocus.length / eventStore.focusChanges.length,\n            weight: 6,\n        });\n    }\n\n    return anomalies;\n};\n\n/**\n * Calculate variance of an array of numbers.\n *\n * @param {Array<number>} arr Array of numbers.\n * @returns {number} Variance.\n */\nconst calculateVariance = (arr) => {\n    if (arr.length < 2) {\n        return 0;\n    }\n    const mean = arr.reduce((a, b) => a + b, 0) / arr.length;\n    const squareDiffs = arr.map((value) => Math.pow(value - mean, 2));\n    return squareDiffs.reduce((a, b) => a + b, 0) / arr.length;\n};\n\n/**\n * Calculate overall interaction score.\n *\n * @param {Array} anomalies Detected anomalies.\n * @returns {number} Score from 0-100.\n */\nconst calculateInteractionScore = (anomalies) => {\n    if (anomalies.length === 0) {\n        return 0;\n    }\n\n    const totalWeight = anomalies.reduce((sum, a) => sum + (a.weight || 0), 0);\n    const maxPossibleWeight = anomalies.length * 10;\n\n    // Check for \"smoking gun\" combinations that indicate definite agent.\n    const hasSuperhuman = anomalies.some((a) => a.name === 'click.superhuman_speed');\n    const hasCenterPrecision = anomalies.some((a) => a.name === 'click.center_precision');\n    const hasTeleport = anomalies.some((a) => a.name === 'click.teleport_pattern');\n    const hasNoMovement = anomalies.some((a) => a.name === 'click.no_movement');\n\n    // Multiple strong signals = high confidence agent.\n    let multiplier = 1.0;\n    const strongSignals = [hasSuperhuman, hasCenterPrecision, hasTeleport, hasNoMovement].filter(Boolean).length;\n    if (strongSignals >= 3) {\n        multiplier = 1.5; // 3+ strong signals = very likely agent.\n    } else if (strongSignals >= 2) {\n        multiplier = 1.25; // 2 strong signals = boost score.\n    }\n\n    // Normalize and apply scaling.\n    const rawScore = (totalWeight / Math.max(maxPossibleWeight, 30)) * 100 * multiplier;\n    return Math.min(100, Math.round(rawScore));\n};\n\n/**\n * Get raw event data for debugging/inspection.\n *\n * @returns {Object} Event store data.\n */\nexport const getRawData = () => {\n    return {\n        ...eventStore,\n        isMonitoring,\n    };\n};\n\n/**\n * Reset all collected data.\n *\n * @returns {void}\n */\nexport const reset = () => {\n    eventStore.mouseMoves = [];\n    eventStore.clicks = [];\n    eventStore.keystrokes = [];\n    eventStore.scrolls = [];\n    eventStore.hovers = [];\n    eventStore.focusChanges = [];\n    eventStore.startTime = Date.now();\n    analysisCache = null;\n};\n\nexport default {\n    startMonitoring,\n    stopMonitoring,\n    analyze,\n    getRawData,\n    reset,\n    CONFIG,\n};\n"],"names":["CONFIG","minMouseMoves","minClicks","minKeystrokes","perfectTimingVariance","minHumanReactionTime","maxMouseSpeed","centerClickTolerance","maxStoredEvents","analysisInterval","eventStore","mouseMoves","clicks","keystrokes","scrolls","hovers","focusChanges","startTime","Date","now","analysisCache","isMonitoring","startMonitoring","document","addEventListener","handleMouseMove","passive","handleClick","capture","handleMouseDown","handleMouseUp","handleMouseOver","handleMouseOut","handleKeyDown","handleKeyUp","handleScroll","window","handleFocusIn","handleFocusOut","stopMonitoring","removeEventListener","e","performance","lastMove","length","moveData","x","clientX","y","clientY","timestamp","deltaTime","deltaX","deltaY","distance","Math","sqrt","velocity","addToStore","target","rect","getBoundingClientRect","elementCenterX","left","width","elementCenterY","top","height","offsetFromCenter","clickData","tagName","id","className","hadPrecedingHover","checkPrecedingHover","hadPrecedingMouseMove","checkPrecedingMouseMove","lastClick","mousedownTime","clickDuration","type","lastKeystroke","key","keydowns","filter","k","holdDuration","matchingKeydown","lastScroll","scrollY","scrollX","storeName","data","push","shift","slice","some","h","recentMoves","m","analyze","results","duration","eventCounts","anomalies","score","analyzeMouseMovement","analyzeClicks","analyzeKeystrokes","analyzeScrolling","analyzeEventSequence","calculateInteractionScore","moves","name","value","weight","linearSegments","findLinearSegments","teleports","velocities","map","variance","calculateVariance","linearCount","i","angle1","atan2","angle2","abs","cos","centerClicks","c","noHoverClicks","noMoveClicks","totalMouseMoves","interClickTimes","fastClicks","t","interKeyTimes","fastKeys","holdDurations","instantScrolls","s","scrollAmounts","v","hoverRatio","max","directFocus","f","arr","mean","reduce","a","b","pow","totalWeight","sum","maxPossibleWeight","multiplier","strongSignals","Boolean","rawScore","min","round","getRawData","reset"],"mappings":"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"}